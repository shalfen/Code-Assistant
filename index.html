<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Assistant - Professional Development Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💻</text></svg>">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: #0f0f23;
            color: #ffffff;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1a1a2e;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #16213e;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #0f3460;
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.4);
        }
        
        .tab-inactive {
            background: #1a1a2e;
            border: 1px solid #16213e;
        }
        
        .tab-inactive:hover {
            background: #16213e;
            border-color: #0f3460;
        }
        
        .project-item {
            background: #1a1a2e;
            border: 1px solid #16213e;
            transition: all 0.3s ease;
        }
        
        .project-item:hover {
            background: #16213e;
            border-color: #0f3460;
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover {
            box-shadow: 0 6px 20px 0 rgba(102, 126, 234, 0.6);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #1a1a2e;
            border: 1px solid #16213e;
        }
        
        .btn-secondary:hover {
            background: #16213e;
            border-color: #0f3460;
        }
        
        .input-field {
            background: #1a1a2e;
            border: 1px solid #16213e;
            color: #ffffff;
        }
        
        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .editor-container {
            height: 500px;
            border: 1px solid #16213e;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .preview-container {
            background: #ffffff;
            border: 1px solid #16213e;
            border-radius: 8px;
            min-height: 500px;
            padding: 0;
            overflow: auto;
        }
        
        .thinking-area {
            background: #1a1a2e;
            border: 1px solid #16213e;
            border-radius: 8px;
            padding: 20px;
            height: 500px;
            overflow-y: auto;
        }
        
        .sidebar {
            background: #16213e;
            border-right: 1px solid #0f3460;
        }
        
        .main-content {
            background: #0f0f23;
        }
        
        .loading-spinner {
            border: 2px solid #1a1a2e;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .api-key-section {
            background: #1a1a2e;
            border: 1px solid #16213e;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .api-key-saved {
            color: #10b981;
        }
        
        .api-key-missing {
            color: #ef4444;
        }
        
        #livePreview {
            background: white;
            color: #333;
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }
        
        .language-btn-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-80 p-6 overflow-y-auto custom-scrollbar">
            <div class="mb-8">
                <h1 class="text-2xl font-bold mb-2 text-white">
                    <i class="fas fa-code mr-2 text-purple-400"></i>
                    AI Code Assistant
                </h1>
                <p class="text-gray-400 text-sm">Professional Development Tool</p>
            </div>
            
            <!-- API Key Configuration -->
            <div class="api-key-section">
                <h3 class="text-lg font-semibold text-white mb-3">
                    <i class="fas fa-key mr-2 text-yellow-400"></i>
                    API Configuration
                </h3>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-300 mb-2">OpenAI API Key</label>
                    <input 
                        type="password" 
                        id="apiKeyInput" 
                        class="input-field w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" 
                        placeholder="sk-..."
                    >
                </div>
                <div class="flex items-center justify-between">
                    <button id="saveApiKeyBtn" class="btn-primary px-4 py-2 rounded-lg text-white font-medium transition-all duration-300 text-sm">
                        <i class="fas fa-save mr-2"></i>
                        Save Key
                    </button>
                    <span id="apiKeyStatus" class="text-sm">
                        <i class="fas fa-times-circle api-key-missing"></i>
                        <span class="api-key-missing">Not configured</span>
                    </span>
                </div>
                <p class="text-xs text-gray-400 mt-2">
                    <i class="fas fa-shield-alt mr-1"></i>
                    Keys are stored locally in your browser
                </p>
            </div>
            
            <!-- AI Model Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-2">AI Model</label>
                <select id="aiModel" class="input-field w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="gpt-4">GPT-4</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                </select>
            </div>
            
            <!-- New Project Button -->
            <button id="newProjectBtn" class="btn-primary w-full px-4 py-3 rounded-lg text-white font-medium transition-all duration-300 mb-6">
                <i class="fas fa-plus mr-2"></i>
                New Project
            </button>
            
            <!-- Saved Projects -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-white mb-4">
                    <i class="fas fa-folder mr-2 text-blue-400"></i>
                    Saved Projects
                </h2>
                <div id="projectsList" class="space-y-2">
                    <!-- Projects will be loaded here -->
                </div>
            </div>
            
            <!-- Project Actions -->
            <div class="space-y-2">
                <button id="saveProjectBtn" class="btn-secondary w-full px-4 py-2 rounded-lg text-white font-medium transition-all duration-300">
                    <i class="fas fa-save mr-2"></i>
                    Save Current Project
                </button>
                <button id="exportProjectBtn" class="btn-secondary w-full px-4 py-2 rounded-lg text-white font-medium transition-all duration-300">
                    <i class="fas fa-download mr-2"></i>
                    Export Project
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content flex-1 flex flex-col">
            <!-- Top Section - Tabs and Content -->
            <div class="flex-1 p-6">
                <!-- Tab Navigation -->
                <div class="flex space-x-2 mb-6">
                    <button id="thinkingTab" class="tab-active px-6 py-3 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-brain mr-2"></i>
                        Thinking
                    </button>
                    <button id="codeTab" class="tab-inactive px-6 py-3 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-code mr-2"></i>
                        Code
                    </button>
                    <button id="previewTab" class="tab-inactive px-6 py-3 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-eye mr-2"></i>
                        Live Preview
                    </button>
                </div>
                
                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Thinking Tab -->
                    <div id="thinkingContent" class="tab-pane">
                        <div class="thinking-area custom-scrollbar">
                            <div id="thinkingText" class="text-gray-300 leading-relaxed">
                                <div class="text-center text-gray-500 mt-20">
                                    <i class="fas fa-lightbulb text-4xl mb-4"></i>
                                    <p>AI thoughts and explanations will appear here...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Code Tab -->
                    <div id="codeContent" class="tab-pane hidden">
                        <div class="mb-4 flex space-x-2">
                            <button id="htmlBtn" class="btn-secondary px-4 py-2 rounded-lg text-white font-medium transition-all duration-300">
                                HTML
                            </button>
                            <button id="cssBtn" class="btn-secondary px-4 py-2 rounded-lg text-white font-medium transition-all duration-300">
                                CSS
                            </button>
                            <button id="jsBtn" class="btn-secondary px-4 py-2 rounded-lg text-white font-medium transition-all duration-300">
                                JavaScript
                            </button>
                        </div>
                        <div class="editor-container">
                            <div id="editor"></div>
                        </div>
                    </div>
                    
                    <!-- Preview Tab -->
                    <div id="previewContent" class="tab-pane hidden">
                        <div class="preview-container">
                            <div id="livePreview"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Section - Prompt Input -->
            <div class="p-6 border-t border-gray-700">
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <textarea 
                            id="promptInput" 
                            class="input-field w-full px-4 py-3 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-purple-500" 
                            rows="3" 
                            placeholder="Describe what you want to build, add, fix, or change... (e.g., 'Create a login form with email and password fields')"
                        ></textarea>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button id="generateBtn" class="btn-primary px-6 py-3 rounded-lg text-white font-medium transition-all duration-300 flex items-center">
                            <i class="fas fa-magic mr-2"></i>
                            Generate
                        </button>
                        <button id="updateBtn" class="btn-secondary px-6 py-3 rounded-lg text-white font-medium transition-all duration-300 flex items-center">
                            <i class="fas fa-sync mr-2"></i>
                            Update
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Project Name Modal -->
    <div id="projectNameModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">Save Project</h3>
            <input id="projectNameInput" type="text" class="input-field w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4" placeholder="Enter project name...">
            <div class="flex space-x-3">
                <button id="saveConfirmBtn" class="btn-primary flex-1 px-4 py-2 rounded-lg text-white font-medium transition-all duration-300">Save</button>
                <button id="saveCancelBtn" class="btn-secondary flex-1 px-4 py-2 rounded-lg text-white font-medium transition-all duration-300">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    
    <script>
        // Global variables
        let editor = null;
        let currentProject = {
            id: null,
            name: 'Untitled Project',
            html: '<h1>Hello World!</h1>\n<p>Welcome to your new project!</p>',
            css: 'body {\n    font-family: Arial, sans-serif;\n    margin: 0;\n    padding: 20px;\n    background-color: #f0f0f0;\n}\n\nh1 {\n    color: #333;\n    text-align: center;\n    margin-bottom: 20px;\n}\n\np {\n    color: #666;\n    text-align: center;\n    font-size: 16px;\n}',
            js: '// Your JavaScript code here\nconsole.log("Hello World!");\n\n// Example: Add click event to elements\ndocument.addEventListener("DOMContentLoaded", function() {\n    console.log("Page loaded successfully!");\n});'
        };
        let currentLanguage = 'html';
        let currentTab = 'thinking';
        let dynamicStyleId = 'dynamic-preview-styles';
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMonacoEditor();
            loadProjects();
            setupEventListeners();
            loadApiKey();
            updatePreview();
        });
        
        // Initialize Monaco Editor
        function initializeMonacoEditor() {
            require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
            require(['vs/editor/editor.main'], function () {
                editor = monaco.editor.create(document.getElementById('editor'), {
                    value: currentProject.html,
                    language: 'html',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    fontSize: 14,
                    lineNumbers: 'on',
                    roundedSelection: false,
                    scrollBeyondLastLine: false,
                    readOnly: false,
                    minimap: { enabled: true }
                });
                
                // Auto-save changes
                editor.onDidChangeModelContent(() => {
                    const content = editor.getValue();
                    currentProject[currentLanguage] = content;
                    if (currentTab === 'preview') {
                        updatePreview();
                    }
                });
                
                // Set initial language button state
                switchLanguage('html');
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.getElementById('thinkingTab').addEventListener('click', () => switchTab('thinking'));
            document.getElementById('codeTab').addEventListener('click', () => switchTab('code'));
            document.getElementById('previewTab').addEventListener('click', () => switchTab('preview'));
            
            // Code language switching
            document.getElementById('htmlBtn').addEventListener('click', () => switchLanguage('html'));
            document.getElementById('cssBtn').addEventListener('click', () => switchLanguage('css'));
            document.getElementById('jsBtn').addEventListener('click', () => switchLanguage('js'));
            
            // API Key management
            document.getElementById('saveApiKeyBtn').addEventListener('click', saveApiKey);
            
            // Project management
            document.getElementById('newProjectBtn').addEventListener('click', newProject);
            document.getElementById('saveProjectBtn').addEventListener('click', () => showSaveModal());
            document.getElementById('exportProjectBtn').addEventListener('click', exportProject);
            
            // AI Generation
            document.getElementById('generateBtn').addEventListener('click', generateCode);
            document.getElementById('updateBtn').addEventListener('click', updateCode);
            
            // Modal handlers
            document.getElementById('saveConfirmBtn').addEventListener('click', confirmSaveProject);
            document.getElementById('saveCancelBtn').addEventListener('click', hideSaveModal);
            document.getElementById('projectNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') confirmSaveProject();
            });
            
            // Prompt input
            document.getElementById('promptInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    generateCode();
                }
            });
        }
        
        // API Key Management
        function loadApiKey() {
            const apiKey = localStorage.getItem('openai_api_key');
            if (apiKey) {
                document.getElementById('apiKeyInput').value = apiKey;
                updateApiKeyStatus(true);
            }
        }
        
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey) {
                localStorage.setItem('openai_api_key', apiKey);
                updateApiKeyStatus(true);
                showToast('API key saved successfully!');
            } else {
                showToast('Please enter a valid API key', 'error');
            }
        }
        
        function updateApiKeyStatus(hasKey) {
            const statusElement = document.getElementById('apiKeyStatus');
            if (hasKey) {
                statusElement.innerHTML = `
                    <i class="fas fa-check-circle api-key-saved"></i>
                    <span class="api-key-saved">Configured</span>
                `;
            } else {
                statusElement.innerHTML = `
                    <i class="fas fa-times-circle api-key-missing"></i>
                    <span class="api-key-missing">Not configured</span>
                `;
            }
        }
        
        // Direct DOM Preview Functions
        function updatePreview() {
            const previewDiv = document.getElementById('livePreview');
            
            // Clear existing content
            previewDiv.innerHTML = '';
            
            // Remove existing dynamic styles
            const existingStyle = document.getElementById(dynamicStyleId);
            if (existingStyle) {
                existingStyle.remove();
            }
            
            // Clean HTML by removing document structure tags
            const cleanedHTML = currentProject.html
                .replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '')
                .replace(/<!DOCTYPE html>|<html.*?>|<\/html>|<head.*?>|<\/head>|<body.*?>|<\/body>/gi, '');
            
            // Insert HTML directly into preview div
            previewDiv.innerHTML = cleanedHTML;
            
            // Inject CSS styles
            if (currentProject.css) {
                const styleElement = document.createElement('style');
                styleElement.id = dynamicStyleId;
                styleElement.textContent = `
                    #livePreview {
                        ${currentProject.css}
                    }
                    #livePreview * {
                        ${currentProject.css}
                    }
                `;
                document.head.appendChild(styleElement);
            }
            
            // Execute JavaScript safely
            if (currentProject.js) {
                try {
                    // Create a scoped context for the preview
                    const previewContext = {
                        document: {
                            ...document,
                            querySelector: (selector) => previewDiv.querySelector(selector),
                            querySelectorAll: (selector) => previewDiv.querySelectorAll(selector),
                            getElementById: (id) => previewDiv.querySelector(`#${id}`),
                            getElementsByClassName: (className) => previewDiv.getElementsByClassName(className),
                            getElementsByTagName: (tagName) => previewDiv.getElementsByTagName(tagName),
                            addEventListener: (event, handler) => previewDiv.addEventListener(event, handler)
                        },
                        console: console,
                        alert: alert,
                        prompt: prompt,
                        confirm: confirm
                    };
                    
                    // Execute JavaScript in the context of the preview
                    const jsFunction = new Function(
                        'document', 'console', 'alert', 'prompt', 'confirm',
                        currentProject.js
                    );
                    jsFunction(previewContext.document, console, alert, prompt, confirm);
                    
                } catch (error) {
                    console.error('Preview JavaScript Error:', error);
                    const errorElement = document.createElement('div');
                    errorElement.style.cssText = 'color: red; background: #ffe6e6; padding: 10px; border: 1px solid red; margin: 10px 0; border-radius: 4px; font-family: monospace;';
                    errorElement.textContent = 'JavaScript Error: ' + error.message;
                    previewDiv.appendChild(errorElement);
                }
            }
        }
        
        // Tab switching functionality
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.className = tab.id === `${tabName}Tab` ? 'tab-active px-6 py-3 rounded-lg font-medium transition-all duration-300' : 'tab-inactive px-6 py-3 rounded-lg font-medium transition-all duration-300';
            });
            
            // Update tab content
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.add('hidden');
            });
            document.getElementById(`${tabName}Content`).classList.remove('hidden');
            
            currentTab = tabName;
            
            if (tabName === 'preview') {
                updatePreview();
            }
        }
        
        // Language switching for code editor
        function switchLanguage(lang) {
            if (!editor) return;
            
            // Save current content
            currentProject[currentLanguage] = editor.getValue();
            
            // Switch language
            currentLanguage = lang;
            const languageMap = { html: 'html', css: 'css', js: 'javascript' };
            
            monaco.editor.setModelLanguage(editor.getModel(), languageMap[lang]);
            editor.setValue(currentProject[lang]);
            
            // Update button states
            document.getElementById('htmlBtn').className = lang === 'html' ? 'language-btn-active px-4 py-2 rounded-lg text-white font-medium transition-all duration-300' : 'btn-secondary px-4 py-2 rounded-lg text-white font-medium transition-all duration-300';
            document.getElementById('cssBtn').className = lang === 'css' ? 'language-btn-active px-4 py-2 rounded-lg text-white font-medium transition-all duration-300' : 'btn-secondary px-4 py-2 rounded-lg text-white font-medium transition-all duration-300';
            document.getElementById('jsBtn').className = lang === 'js' ? 'language-btn-active px-4 py-2 rounded-lg text-white font-medium transition-all duration-300' : 'btn-secondary px-4 py-2 rounded-lg text-white font-medium transition-all duration-300';
        }
        
        // Project management functions
        function newProject() {
            currentProject = {
                id: null,
                name: 'Untitled Project',
                html: '<h1>Hello World!</h1>\n<p>Welcome to your new project!</p>',
                css: 'body {\n    font-family: Arial, sans-serif;\n    margin: 0;\n    padding: 20px;\n    background-color: #f0f0f0;\n}\n\nh1 {\n    color: #333;\n    text-align: center;\n    margin-bottom: 20px;\n}\n\np {\n    color: #666;\n    text-align: center;\n    font-size: 16px;\n}',
                js: '// Your JavaScript code here\nconsole.log("Hello World!");\n\n// Example: Add click event to elements\ndocument.addEventListener("DOMContentLoaded", function() {\n    console.log("Page loaded successfully!");\n});'
            };
            
            if (editor) {
                editor.setValue(currentProject[currentLanguage]);
            }
            
            updatePreview();
            clearThinking();
            document.getElementById('promptInput').value = '';
            showToast('New project created!');
        }
        
        function showSaveModal() {
            document.getElementById('projectNameInput').value = currentProject.name;
            document.getElementById('projectNameModal').classList.remove('hidden');
            document.getElementById('projectNameInput').focus();
        }
        
        function hideSaveModal() {
            document.getElementById('projectNameModal').classList.add('hidden');
        }
        
        function confirmSaveProject() {
            const projectName = document.getElementById('projectNameInput').value.trim();
            if (!projectName) return;
            
            currentProject.name = projectName;
            currentProject.id = currentProject.id || Date.now().toString();
            
            const projects = JSON.parse(localStorage.getItem('aiCodeProjects') || '[]');
            const existingIndex = projects.findIndex(p => p.id === currentProject.id);
            
            if (existingIndex >= 0) {
                projects[existingIndex] = { ...currentProject };
            } else {
                projects.push({ ...currentProject });
            }
            
            localStorage.setItem('aiCodeProjects', JSON.stringify(projects));
            loadProjects();
            hideSaveModal();
            
            showToast('Project saved successfully!');
        }
        
        function loadProjects() {
            const projects = JSON.parse(localStorage.getItem('aiCodeProjects') || '[]');
            const projectsList = document.getElementById('projectsList');
            
            projectsList.innerHTML = '';
            
            if (projects.length === 0) {
                projectsList.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No saved projects</p>';
                return;
            }
            
            projects.forEach(project => {
                const projectElement = document.createElement('div');
                projectElement.className = 'project-item p-3 rounded-lg cursor-pointer';
                projectElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h3 class="text-white font-medium text-sm truncate">${project.name}</h3>
                            <p class="text-gray-400 text-xs mt-1">Modified ${new Date(parseInt(project.id)).toLocaleDateString()}</p>
                        </div>
                        <div class="flex space-x-1 ml-2">
                            <button onclick="loadProject('${project.id}')" class="text-blue-400 hover:text-blue-300 p-1">
                                <i class="fas fa-folder-open text-xs"></i>
                            </button>
                            <button onclick="deleteProject('${project.id}')" class="text-red-400 hover:text-red-300 p-1">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;
                projectsList.appendChild(projectElement);
            });
        }
        
        function loadProject(projectId) {
            const projects = JSON.parse(localStorage.getItem('aiCodeProjects') || '[]');
            const project = projects.find(p => p.id === projectId);
            
            if (project) {
                currentProject = { ...project };
                if (editor) {
                    editor.setValue(currentProject[currentLanguage]);
                }
                updatePreview();
                showToast('Project loaded successfully!');
            }
        }
        
        function deleteProject(projectId) {
            if (confirm('Are you sure you want to delete this project?')) {
                const projects = JSON.parse(localStorage.getItem('aiCodeProjects') || '[]');
                const filteredProjects = projects.filter(p => p.id !== projectId);
                localStorage.setItem('aiCodeProjects', JSON.stringify(filteredProjects));
                loadProjects();
                showToast('Project deleted successfully!');
            }
        }
        
        function exportProject() {
            const dataStr = JSON.stringify(currentProject, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentProject.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // AI Code Generation
        async function generateCode() {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                showToast('Please enter a prompt', 'error');
                return;
            }
            
            const apiKey = localStorage.getItem('openai_api_key');
            if (!apiKey) {
                showToast('Please configure your API key first', 'error');
                return;
            }
            
            const aiModel = document.getElementById('aiModel').value;
            const generateBtn = document.getElementById('generateBtn');
            const originalHTML = generateBtn.innerHTML;
            
            try {
                generateBtn.innerHTML = '<div class="loading-spinner mr-2"></div>Generating...';
                generateBtn.disabled = true;
                
                // Switch to thinking tab and show AI thinking
                switchTab('thinking');
                updateThinking('🤔 Analyzing your request...\n\nPrompt: "' + prompt + '"\n\nConnecting to OpenAI API...');
                
                const response = await callOpenAI(prompt, aiModel, apiKey, 'generate');
                
                if (response.error) {
                    updateThinking('❌ Error: ' + response.error);
                    showToast('Error: ' + response.error, 'error');
                    return;
                }
                
                updateThinking(response.thinking);
                
                // Update code
                if (response.code.html) currentProject.html = response.code.html;
                if (response.code.css) currentProject.css = response.code.css;
                if (response.code.js) currentProject.js = response.code.js;
                
                // Update editor if in code tab
                if (editor) {
                    editor.setValue(currentProject[currentLanguage]);
                }
                
                updatePreview();
                document.getElementById('promptInput').value = '';
                showToast('Code generated successfully!');
                
            } catch (error) {
                console.error('Error generating code:', error);
                updateThinking('❌ Error: ' + error.message);
                showToast('Error generating code. Please try again.', 'error');
            } finally {
                generateBtn.innerHTML = originalHTML;
                generateBtn.disabled = false;
            }
        }
        
        async function updateCode() {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                showToast('Please enter a prompt', 'error');
                return;
            }
            
            const apiKey = localStorage.getItem('openai_api_key');
            if (!apiKey) {
                showToast('Please configure your API key first', 'error');
                return;
            }
            
            const aiModel = document.getElementById('aiModel').value;
            const updateBtn = document.getElementById('updateBtn');
            const originalHTML = updateBtn.innerHTML;
            
            try {
                updateBtn.innerHTML = '<div class="loading-spinner mr-2"></div>Updating...';
                updateBtn.disabled = true;
                
                switchTab('thinking');
                updateThinking('🔄 Analyzing current code and your update request...\n\nUpdate: "' + prompt + '"\n\nConnecting to OpenAI API...');
                
                const response = await callOpenAI(prompt, aiModel, apiKey, 'update');
                
                if (response.error) {
                    updateThinking('❌ Error: ' + response.error);
                    showToast('Error: ' + response.error, 'error');
                    return;
                }
                
                updateThinking(response.thinking);
                
                // Update code
                if (response.code.html) currentProject.html = response.code.html;
                if (response.code.css) currentProject.css = response.code.css;
                if (response.code.js) currentProject.js = response.code.js;
                
                if (editor) {
                    editor.setValue(currentProject[currentLanguage]);
                }
                
                updatePreview();
                document.getElementById('promptInput').value = '';
                showToast('Code updated successfully!');
                
            } catch (error) {
                console.error('Error updating code:', error);
                updateThinking('❌ Error: ' + error.message);
                showToast('Error updating code. Please try again.', 'error');
            } finally {
                updateBtn.innerHTML = originalHTML;
                updateBtn.disabled = false;
            }
        }
        
        // OpenAI API Call
        async function callOpenAI(prompt, model, apiKey, type) {
            const systemPrompt = `You are a professional web developer AI assistant. Your task is to ${type} HTML, CSS, and JavaScript code based on user requests.

IMPORTANT RULES:
1. Always respond with valid JSON in this exact format:
{
  "thinking": "Your detailed explanation of what you're doing and why",
  "code": {
    "html": "HTML code here",
    "css": "CSS code here", 
    "js": "JavaScript code here"
  }
}

2. For HTML: Create semantic, accessible HTML without document structure tags (no <html>, <head>, <body>)
3. For CSS: Write clean, modern CSS with proper selectors
4. For JavaScript: Write clean, modern JavaScript with proper error handling
5. Always explain your thinking process in the "thinking" field
6. Make code production-ready and well-commented

${type === 'update' ? `Current project code:
HTML: ${currentProject.html}
CSS: ${currentProject.css} 
JavaScript: ${currentProject.js}

Please update this code based on the user's request.` : 'Create new code from scratch based on the user\'s request.'}`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: prompt }
                        ],
                        max_tokens: 4000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No valid JSON found in response');
                    }
                } catch (parseError) {
                    // Fallback if JSON parsing fails
                    return {
                        thinking: `✨ Using ${model.toUpperCase()} to ${type} code...

📝 **Analysis:**
I understand you want to: "${prompt}"

💻 **Generated Response:**
${content}

✅ **Note:** The AI provided a response but it wasn't in the expected JSON format. The content has been processed as best as possible.`,
                        code: {
                            html: content.includes('<') ? content : `<div class="generated-content">${content}</div>`,
                            css: 'body { font-family: Arial, sans-serif; margin: 20px; }',
                            js: '// AI generated content\nconsole.log("Content generated by AI");'
                        }
                    };
                }
                
            } catch (error) {
                return {
                    error: error.message,
                    thinking: `❌ Error occurred while calling OpenAI API: ${error.message}`
                };
            }
        }
        
        // Utility functions
        function updateThinking(text) {
            document.getElementById('thinkingText').innerHTML = `<div class="fade-in">${text.replace(/\n/g, '<br>')}</div>`;
        }
        
        function clearThinking() {
            document.getElementById('thinkingText').innerHTML = `
                <div class="text-center text-gray-500 mt-20">
                    <i class="fas fa-lightbulb text-4xl mb-4"></i>
                    <p>AI thoughts and explanations will appear here...</p>
                </div>
            `;
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 fade-in ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Make functions global for onclick handlers
        window.loadProject = loadProject;
        window.deleteProject = deleteProject;
    </script>
</body>
</html>
