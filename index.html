<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Assistant - Professional Development Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>💻</text></svg>">
    <style>
        * {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0f0f23;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1a1a2e;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #16213e;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #0f3460;
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .tab-inactive {
            background: #1a1a2e;
            border: 1px solid #16213e;
            color: #a0aec0;
        }
        
        .tab-inactive:hover {
            background: #16213e;
            border-color: #0f3460;
        }
        
        .project-item {
            background: #1a1a2e;
            border: 1px solid #16213e;
            transition: all 0.3s ease;
        }
        
        .project-item:hover {
            background: #16213e;
            border-color: #0f3460;
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.4);
            color: white;
            border: none;
        }
        
        .btn-primary:hover {
            box-shadow: 0 6px 20px 0 rgba(102, 126, 234, 0.6);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #1a1a2e;
            border: 1px solid #16213e;
            color: #a0aec0;
        }
        
        .btn-secondary:hover {
            background: #16213e;
            border-color: #0f3460;
        }
        
        .btn-danger {
            background: #ef4444;
            border: none;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .input-field {
            background: #1a1a2e;
            border: 1px solid #16213e;
            color: #ffffff;
        }
        
        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        
        .editor-container {
            height: calc(100vh - 300px);
            min-height: 500px;
            border: 1px solid #16213e;
            border-radius: 8px;
            overflow: hidden;
            background: #1e1e1e;
        }
        
        .editor-wrapper {
            height: 100%;
            width: 100%;
            position: relative;
        }
        
        #editor {
            height: 100% !important;
            width: 100% !important;
        }
        
        .live-preview-area {
            background: #ffffff;
            border: 1px solid #16213e;
            border-radius: 8px;
            padding: 20px;
            min-height: 500px;
            height: calc(100vh - 300px);
            overflow-y: auto;
            color: #333;
        }
        
        .thinking-area {
            background: #1a1a2e;
            border: 1px solid #16213e;
            border-radius: 8px;
            padding: 20px;
            height: calc(100vh - 300px);
            min-height: 500px;
            overflow-y: auto;
            color: #e2e8f0;
            line-height: 1.6;
        }
        
        .sidebar {
            background: #16213e;
            border-right: 1px solid #0f3460;
            width: 320px;
            flex-shrink: 0;
        }
        
        .main-content {
            background: #0f0f23;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .tab-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .tab-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .tab-pane.hidden {
            display: none;
        }
        
        .code-editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .loading-spinner {
            border: 2px solid #1a1a2e;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .api-key-section {
            background: #1a1a2e;
            border: 1px solid #16213e;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .api-key-input {
            background: #16213e;
            border: 1px solid #0f3460;
            color: #ffffff;
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .api-key-input:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
        }
        
        .status-indicator.success {
            color: #22c55e;
        }
        
        .status-indicator.error {
            color: #ef4444;
        }
        
        .security-notice {
            background: #1e1b4b;
            border: 1px solid #3730a3;
            color: #a5b4fc;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .app-layout {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .content-area {
            flex: 1;
            padding: 24px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .bottom-section {
            flex-shrink: 0;
            padding: 24px;
            border-top: 1px solid #374151;
            background: #111827;
        }
        
        .language-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .language-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #374151;
            background: #1f2937;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .language-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .language-btn:hover {
            border-color: #667eea;
            color: #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <div class="sidebar p-6 overflow-y-auto custom-scrollbar">
            <div class="mb-8">
                <h1 class="text-2xl font-bold mb-2 text-white">
                    <i class="fas fa-code mr-2 text-purple-400"></i>
                    AI Code Assistant
                </h1>
                <p class="text-gray-400 text-sm">Professional Development Tool</p>
            </div>
            
            <!-- API Key Configuration -->
            <div class="api-key-section mb-6">
                <h3 class="text-sm font-semibold text-white mb-3">
                    <i class="fas fa-key mr-2 text-yellow-400"></i>
                    API Configuration
                </h3>
                <input type="password" id="apiKeyInput" class="api-key-input" placeholder="Enter your OpenAI API key...">
                <button id="saveApiKeyBtn" class="btn-primary w-full px-3 py-2 rounded text-sm font-medium transition-all duration-300">
                    <i class="fas fa-save mr-2"></i>
                    Save API Key
                </button>
                <div id="apiKeyStatus" class="mt-2 text-sm">
                    <span id="statusText" class="text-gray-400">No API key configured</span>
                    <span id="statusIcon" class="status-indicator"></span>
                </div>
                <div class="security-notice">
                    <i class="fas fa-shield-alt mr-2"></i>
                    API keys are stored locally in your browser. Never share your keys publicly.
                </div>
            </div>
            
            <!-- AI Model Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-2">AI Model</label>
                <select id="aiModel" class="input-field w-full px-3 py-2 rounded-lg">
                    <option value="gpt-4">GPT-4</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                </select>
            </div>
            
            <!-- New Project Button -->
            <button id="newProjectBtn" class="btn-primary w-full px-4 py-3 rounded-lg text-white font-medium transition-all duration-300 mb-6">
                <i class="fas fa-plus mr-2"></i>
                New Project
            </button>
            
            <!-- Saved Projects -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-white mb-4">
                    <i class="fas fa-folder mr-2 text-blue-400"></i>
                    Saved Projects
                </h2>
                <div id="projectsList" class="space-y-2">
                    <!-- Projects will be loaded here -->
                </div>
            </div>
            
            <!-- Project Actions -->
            <div class="space-y-2">
                <button id="saveProjectBtn" class="btn-secondary w-full px-4 py-2 rounded-lg text-white font-medium transition-all duration-300">
                    <i class="fas fa-save mr-2"></i>
                    Save Current Project
                </button>
                <button id="exportProjectBtn" class="btn-secondary w-full px-4 py-2 rounded-lg text-white font-medium transition-all duration-300">
                    <i class="fas fa-download mr-2"></i>
                    Export Project
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Content Area -->
            <div class="content-area">
                <!-- Tab Navigation -->
                <div class="flex space-x-2 mb-6">
                    <button id="thinkingTab" class="tab-active px-6 py-3 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-brain mr-2"></i>
                        Thinking
                    </button>
                    <button id="codeTab" class="tab-inactive px-6 py-3 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-code mr-2"></i>
                        Code
                    </button>
                    <button id="previewTab" class="tab-inactive px-6 py-3 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-eye mr-2"></i>
                        Live Preview
                    </button>
                </div>
                
                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Thinking Tab -->
                    <div id="thinkingContent" class="tab-pane">
                        <div class="thinking-area custom-scrollbar">
                            <div id="thinkingText">
                                <div class="text-center text-gray-500 mt-20">
                                    <i class="fas fa-lightbulb text-4xl mb-4"></i>
                                    <p class="text-lg">AI thoughts and explanations will appear here...</p>
                                    <p class="text-sm mt-2">Enter a prompt below and click Generate to see the AI's thinking process.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Code Tab -->
                    <div id="codeContent" class="tab-pane hidden">
                        <div class="code-editor-section">
                            <div class="language-buttons">
                                <button id="htmlBtn" class="language-btn active">
                                    <i class="fab fa-html5 mr-2"></i>HTML
                                </button>
                                <button id="cssBtn" class="language-btn">
                                    <i class="fab fa-css3-alt mr-2"></i>CSS
                                </button>
                                <button id="jsBtn" class="language-btn">
                                    <i class="fab fa-js mr-2"></i>JavaScript
                                </button>
                            </div>
                            <div class="editor-container">
                                <div class="editor-wrapper">
                                    <div id="editor"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview Tab -->
                    <div id="previewContent" class="tab-pane hidden">
                        <div class="live-preview-area custom-scrollbar">
                            <div class="text-center text-gray-500 mt-20">
                                <i class="fas fa-eye text-4xl mb-4"></i>
                                <p class="text-lg">Live preview will appear here...</p>
                                <p class="text-sm mt-2">Generate some code to see the live preview in action.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Section - Prompt Input -->
            <div class="bottom-section">
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <textarea 
                            id="promptInput" 
                            class="input-field w-full px-4 py-3 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-purple-500" 
                            rows="3" 
                            placeholder="Describe what you want to build, add, fix, or change... (e.g., 'Create a responsive login form with email and password fields')"
                        ></textarea>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button id="generateBtn" class="btn-primary px-6 py-3 rounded-lg text-white font-medium transition-all duration-300 flex items-center">
                            <i class="fas fa-magic mr-2"></i>
                            Generate
                        </button>
                        <button id="updateBtn" class="btn-secondary px-6 py-3 rounded-lg text-white font-medium transition-all duration-300 flex items-center">
                            <i class="fas fa-sync mr-2"></i>
                            Update
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Project Name Modal -->
    <div id="projectNameModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">Save Project</h3>
            <input id="projectNameInput" type="text" class="input-field w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4" placeholder="Enter project name...">
            <div class="flex space-x-3">
                <button id="saveConfirmBtn" class="btn-primary flex-1 px-4 py-2 rounded-lg text-white font-medium transition-all duration-300">Save</button>
                <button id="saveCancelBtn" class="btn-secondary flex-1 px-4 py-2 rounded-lg text-white font-medium transition-all duration-300">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    
    <script>
        // Global variables
        let editor = null;
        let currentProject = {
            id: null,
            name: 'Untitled Project',
            html: '<!DOCTYPE html>\n<html>\n<head>\n    <title>My Project</title>\n</head>\n<body>\n    <h1>Hello World!</h1>\n    <p>Welcome to AI Code Assistant!</p>\n</body>\n</html>',
            css: 'body {\n    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n    margin: 0;\n    padding: 40px;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    min-height: 100vh;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    color: white;\n}\n\nh1 {\n    font-size: 3rem;\n    margin-bottom: 1rem;\n    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\n}\n\np {\n    font-size: 1.2rem;\n    opacity: 0.9;\n}',
            js: '// Welcome to AI Code Assistant!\nconsole.log("Hello World!");\n\n// Add interactive functionality here\ndocument.addEventListener("DOMContentLoaded", function() {\n    console.log("Page loaded successfully!");\n    \n    // Example: Add click event to h1\n    const heading = document.querySelector("h1");\n    if (heading) {\n        heading.addEventListener("click", function() {\n            alert("Hello from AI Code Assistant!");\n        });\n    }\n});'
        };
        let currentLanguage = 'html';
        let currentTab = 'thinking';
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMonacoEditor();
            loadProjects();
            setupEventListeners();
            loadApiKeyStatus();
            updatePreview();
        });
        
        // Initialize Monaco Editor
        function initializeMonacoEditor() {
            require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
            require(['vs/editor/editor.main'], function () {
                editor = monaco.editor.create(document.getElementById('editor'), {
                    value: currentProject.html,
                    language: 'html',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    fontSize: 14,
                    lineNumbers: 'on',
                    roundedSelection: false,
                    scrollBeyondLastLine: false,
                    readOnly: false,
                    minimap: { enabled: true },
                    wordWrap: 'on',
                    folding: true,
                    cursorBlinking: 'smooth',
                    cursorSmoothCaretAnimation: true
                });
                
                // Auto-save changes
                editor.onDidChangeModelContent(() => {
                    const content = editor.getValue();
                    currentProject[currentLanguage] = content;
                    if (currentTab === 'preview') {
                        updatePreview();
                    }
                });
                
                // Force resize after creation
                setTimeout(() => {
                    editor.layout();
                }, 100);
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.getElementById('thinkingTab').addEventListener('click', () => switchTab('thinking'));
            document.getElementById('codeTab').addEventListener('click', () => switchTab('code'));
            document.getElementById('previewTab').addEventListener('click', () => switchTab('preview'));
            
            // Code language switching
            document.getElementById('htmlBtn').addEventListener('click', () => switchLanguage('html'));
            document.getElementById('cssBtn').addEventListener('click', () => switchLanguage('css'));
            document.getElementById('jsBtn').addEventListener('click', () => switchLanguage('js'));
            
            // API Key management
            document.getElementById('saveApiKeyBtn').addEventListener('click', saveApiKey);
            document.getElementById('apiKeyInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveApiKey();
            });
            
            // Project management
            document.getElementById('newProjectBtn').addEventListener('click', newProject);
            document.getElementById('saveProjectBtn').addEventListener('click', () => showSaveModal());
            document.getElementById('exportProjectBtn').addEventListener('click', exportProject);
            
            // AI Generation
            document.getElementById('generateBtn').addEventListener('click', generateCode);
            document.getElementById('updateBtn').addEventListener('click', updateCode);
            
            // Modal handlers
            document.getElementById('saveConfirmBtn').addEventListener('click', confirmSaveProject);
            document.getElementById('saveCancelBtn').addEventListener('click', hideSaveModal);
            document.getElementById('projectNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') confirmSaveProject();
            });
            
            // Prompt input
            document.getElementById('promptInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    generateCode();
                }
            });
            
            // Window resize handler
            window.addEventListener('resize', () => {
                if (editor) {
                    setTimeout(() => {
                        editor.layout();
                    }, 100);
                }
            });
        }
        
        // API Key Management
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showToast('Please enter an API key', 'error');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                showToast('Invalid API key format', 'error');
                return;
            }
            
            localStorage.setItem('openai_api_key', apiKey);
            updateApiKeyStatus(true);
            showToast('API key saved successfully!');
            document.getElementById('apiKeyInput').value = '';
        }
        
        function loadApiKeyStatus() {
            const apiKey = localStorage.getItem('openai_api_key');
            updateApiKeyStatus(!!apiKey);
        }
        
        function updateApiKeyStatus(hasKey) {
            const statusText = document.getElementById('statusText');
            const statusIcon = document.getElementById('statusIcon');
            
            if (hasKey) {
                statusText.textContent = 'API key configured';
                statusIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                statusIcon.className = 'status-indicator success';
            } else {
                statusText.textContent = 'No API key configured';
                statusIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                statusIcon.className = 'status-indicator error';
            }
        }
        
        // Tab switching functionality
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.className = tab.id === `${tabName}Tab` ? 'tab-active px-6 py-3 rounded-lg font-medium transition-all duration-300' : 'tab-inactive px-6 py-3 rounded-lg font-medium transition-all duration-300';
            });
            
            // Update tab content
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.add('hidden');
            });
            document.getElementById(`${tabName}Content`).classList.remove('hidden');
            
            currentTab = tabName;
            
            if (tabName === 'preview') {
                updatePreview();
            } else if (tabName === 'code' && editor) {
                setTimeout(() => {
                    editor.layout();
                }, 100);
            }
        }
        
        // Language switching for code editor
        function switchLanguage(lang) {
            if (!editor) return;
            
            // Save current content
            currentProject[currentLanguage] = editor.getValue();
            
            // Switch language
            currentLanguage = lang;
            const languageMap = { html: 'html', css: 'css', js: 'javascript' };
            
            monaco.editor.setModelLanguage(editor.getModel(), languageMap[lang]);
            editor.setValue(currentProject[lang]);
            
            // Update button states
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`${lang}Btn`).classList.add('active');
            
            // Force editor to resize
            setTimeout(() => {
                editor.layout();
            }, 100);
        }
        
        // Update live preview with direct DOM manipulation
        function updatePreview() {
            const previewDiv = document.getElementById('previewContent').querySelector('.live-preview-area');
            
            // Clear previous content
            previewDiv.innerHTML = '';
            
            // Clean the HTML by removing document structure tags
            const cleanedHTML = currentProject.html
                .replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '')
                .replace(/<!DOCTYPE html>|<html.*?>|<\/html>|<head.*?>|<\/head>|<body.*?>|<\/body>/gi, '');
            
            // Insert HTML directly into the preview div
            previewDiv.innerHTML = cleanedHTML;
            
            // Apply CSS styles dynamically
            applyCSSStyles();
            
            // Execute JavaScript safely
            executeJavaScript();
        }
        
        // Apply CSS styles dynamically
        function applyCSSStyles() {
            // Remove existing preview styles
            const existingStyle = document.getElementById('previewStyles');
            if (existingStyle) {
                existingStyle.remove();
            }
            
            // Create new style element
            const styleElement = document.createElement('style');
            styleElement.id = 'previewStyles';
            
            // Scope CSS to preview div to avoid conflicts
            const scopedCSS = currentProject.css
                .split('}')
                .map(rule => {
                    if (rule.trim() && !rule.includes('@') && !rule.includes('body') && !rule.includes('html')) {
                        return `#previewContent .live-preview-area ${rule}}`;
                    } else if (rule.includes('body')) {
                        return rule.replace(/body/g, '#previewContent .live-preview-area') + '}';
                    }
                    return rule + (rule.trim() ? '}' : '');
                })
                .join('');
            
            styleElement.textContent = scopedCSS;
            document.head.appendChild(styleElement);
        }
        
        // Execute JavaScript safely
        function executeJavaScript() {
            try {
                // Create a safe execution context
                const previewArea = document.getElementById('previewContent').querySelector('.live-preview-area');
                const executeInContext = new Function('document', 'window', 'console', 'alert', `
                    const originalDocument = document;
                    const previewDocument = {
                        ...originalDocument,
                        querySelector: (selector) => previewArea.querySelector(selector),
                        querySelectorAll: (selector) => previewArea.querySelectorAll(selector),
                        getElementById: (id) => previewArea.querySelector('#' + id),
                        addEventListener: (event, handler) => {
                            if (event === 'DOMContentLoaded') {
                                handler();
                            } else {
                                originalDocument.addEventListener(event, handler);
                            }
                        }
                    };
                    ${currentProject.js}
                `);
                
                // Execute with limited scope
                const previewArea = document.getElementById('previewContent').querySelector('.live-preview-area');
                executeInContext(
                    previewArea,
                    {},
                    console,
                    (msg) => {
                        const alertDiv = document.createElement('div');
                        alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #333; color: white; padding: 15px; border-radius: 8px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
                        alertDiv.textContent = msg;
                        document.body.appendChild(alertDiv);
                        setTimeout(() => alertDiv.remove(), 3000);
                    }
                );
            } catch (error) {
                console.error('JavaScript execution error:', error);
                
                // Display error in preview
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'color: #ef4444; background: #fef2f2; padding: 15px; border: 1px solid #fecaca; border-radius: 8px; margin: 10px 0; font-family: monospace;';
                errorDiv.innerHTML = `<strong>JavaScript Error:</strong><br>${error.message}`;
                document.getElementById('previewContent').querySelector('.live-preview-area').appendChild(errorDiv);
            }
        }
        
        // Project management functions
        function newProject() {
            currentProject = {
                id: null,
                name: 'Untitled Project',
                html: '<!DOCTYPE html>\n<html>\n<head>\n    <title>My Project</title>\n</head>\n<body>\n    <h1>Hello World!</h1>\n    <p>Welcome to AI Code Assistant!</p>\n</body>\n</html>',
                css: 'body {\n    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n    margin: 0;\n    padding: 40px;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    min-height: 100vh;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    color: white;\n}\n\nh1 {\n    font-size: 3rem;\n    margin-bottom: 1rem;\n    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\n}\n\np {\n    font-size: 1.2rem;\n    opacity: 0.9;\n}',
                js: '// Welcome to AI Code Assistant!\nconsole.log("Hello World!");\n\n// Add interactive functionality here\ndocument.addEventListener("DOMContentLoaded", function() {\n    console.log("Page loaded successfully!");\n    \n    // Example: Add click event to h1\n    const heading = document.querySelector("h1");\n    if (heading) {\n        heading.addEventListener("click", function() {\n            alert("Hello from AI Code Assistant!");\n        });\n    }\n});'
            };
            
            if (editor) {
                editor.setValue(currentProject[currentLanguage]);
            }
            
            updatePreview();
            clearThinking();
            document.getElementById('promptInput').value = '';
            showToast('New project created!');
        }
        
        function showSaveModal() {
            document.getElementById('projectNameInput').value = currentProject.name;
            document.getElementById('projectNameModal').classList.remove('hidden');
            document.getElementById('projectNameInput').focus();
        }
        
        function hideSaveModal() {
            document.getElementById('projectNameModal').classList.add('hidden');
        }
        
        function confirmSaveProject() {
            const projectName = document.getElementById('projectNameInput').value.trim();
            if (!projectName) return;
            
            currentProject.name = projectName;
            currentProject.id = currentProject.id || Date.now().toString();
            
            const projects = JSON.parse(localStorage.getItem('aiCodeProjects') || '[]');
            const existingIndex = projects.findIndex(p => p.id === currentProject.id);
            
            if (existingIndex >= 0) {
                projects[existingIndex] = { ...currentProject };
            } else {
                projects.push({ ...currentProject });
            }
            
            localStorage.setItem('aiCodeProjects', JSON.stringify(projects));
            loadProjects();
            hideSaveModal();
            
            showToast('Project saved successfully!');
        }
        
        function loadProjects() {
            const projects = JSON.parse(localStorage.getItem('aiCodeProjects') || '[]');
            const projectsList = document.getElementById('projectsList');
            
            projectsList.innerHTML = '';
            
            if (projects.length === 0) {
                projectsList.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No saved projects</p>';
                return;
            }
            
            projects.forEach(project => {
                const projectElement = document.createElement('div');
                projectElement.className = 'project-item p-3 rounded-lg cursor-pointer';
                projectElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h3 class="text-white font-medium text-sm truncate">${project.name}</h3>
                            <p class="text-gray-400 text-xs mt-1">Modified ${new Date(parseInt(project.id)).toLocaleDateString()}</p>
                        </div>
                        <div class="flex space-x-1 ml-2">
                            <button onclick="loadProject('${project.id}')" class="text-blue-400 hover:text-blue-300 p-1" title="Load Project">
                                <i class="fas fa-folder-open text-xs"></i>
                            </button>
                            <button onclick="deleteProject('${project.id}')" class="text-red-400 hover:text-red-300 p-1" title="Delete Project">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;
                projectsList.appendChild(projectElement);
            });
        }
        
        function loadProject(projectId) {
            const projects = JSON.parse(localStorage.getItem('aiCodeProjects') || '[]');
            const project = projects.find(p => p.id === projectId);
            
            if (project) {
                currentProject = { ...project };
                if (editor) {
                    editor.setValue(currentProject[currentLanguage]);
                }
                updatePreview();
                showToast('Project loaded successfully!');
            }
        }
        
        function deleteProject(projectId) {
            if (confirm('Are you sure you want to delete this project?')) {
                const projects = JSON.parse(localStorage.getItem('aiCodeProjects') || '[]');
                const filteredProjects = projects.filter(p => p.id !== projectId);
                localStorage.setItem('aiCodeProjects', JSON.stringify(filteredProjects));
                loadProjects();
                showToast('Project deleted successfully!');
            }
        }
        
        function exportProject() {
            const dataStr = JSON.stringify(currentProject, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentProject.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Project exported successfully!');
        }
        
        // AI Code Generation
        async function generateCode() {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                showToast('Please enter a prompt', 'error');
                return;
            }
            
            const apiKey = localStorage.getItem('openai_api_key');
            if (!apiKey) {
                showToast('Please configure your API key first', 'error');
                return;
            }
            
            const aiModel = document.getElementById('aiModel').value;
            const generateBtn = document.getElementById('generateBtn');
            const originalHTML = generateBtn.innerHTML;
            
            try {
                generateBtn.innerHTML = '<div class="loading-spinner mr-2"></div>Generating...';
                generateBtn.disabled = true;
                
                // Switch to thinking tab and show AI thinking
                switchTab('thinking');
                updateThinking('🤔 Analyzing your request...\n\nPrompt: "' + prompt + '"\n\nConnecting to OpenAI API...\n\nGenerating code...');
                
                const response = await callOpenAIAPI(prompt, aiModel, 'generate', apiKey);
                
                updateThinking(response.thinking);
                
                // Update code
                if (response.code.html) currentProject.html = response.code.html;
                if (response.code.css) currentProject.css = response.code.css;
                if (response.code.js) currentProject.js = response.code.js;
                
                // Update editor if in code tab
                if (editor) {
                    editor.setValue(currentProject[currentLanguage]);
                }
                
                updatePreview();
                document.getElementById('promptInput').value = '';
                showToast('Code generated successfully!');
                
            } catch (error) {
                console.error('Error generating code:', error);
                updateThinking('❌ Error: ' + error.message);
                showToast('Error generating code: ' + error.message, 'error');
            } finally {
                generateBtn.innerHTML = originalHTML;
                generateBtn.disabled = false;
            }
        }
        
        async function updateCode() {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                showToast('Please enter a prompt', 'error');
                return;
            }
            
            const apiKey = localStorage.getItem('openai_api_key');
            if (!apiKey) {
                showToast('Please configure your API key first', 'error');
                return;
            }
            
            const aiModel = document.getElementById('aiModel').value;
            const updateBtn = document.getElementById('updateBtn');
            const originalHTML = updateBtn.innerHTML;
            
            try {
                updateBtn.innerHTML = '<div class="loading-spinner mr-2"></div>Updating...';
                updateBtn.disabled = true;
                
                switchTab('thinking');
                updateThinking('🔄 Analyzing current code and your update request...\n\nUpdate: "' + prompt + '"\n\nConnecting to OpenAI API...\n\nUpdating code...');
                
                const response = await callOpenAIAPI(prompt, aiModel, 'update', apiKey);
                
                updateThinking(response.thinking);
                
                // Update code
                if (response.code.html) currentProject.html = response.code.html;
                if (response.code.css) currentProject.css = response.code.css;
                if (response.code.js) currentProject.js = response.code.js;
                
                if (editor) {
                    editor.setValue(currentProject[currentLanguage]);
                }
                
                updatePreview();
                document.getElementById('promptInput').value = '';
                showToast('Code updated successfully!');
                
            } catch (error) {
                console.error('Error updating code:', error);
                updateThinking('❌ Error: ' + error.message);
                showToast('Error updating code: ' + error.message, 'error');
            } finally {
                updateBtn.innerHTML = originalHTML;
                updateBtn.disabled = false;
            }
        }
        
        // Call OpenAI API
        async function callOpenAIAPI(prompt, model, type, apiKey) {
            const systemPrompt = `You are an expert web developer. ${type === 'generate' ? 'Create' : 'Update'} HTML, CSS, and JavaScript code based on the user's request. 
            
            Current project context:
            HTML: ${currentProject.html}
            CSS: ${currentProject.css}
            JavaScript: ${currentProject.js}
            
            Return your response in JSON format with this structure:
            {
                "thinking": "Your detailed thinking process and explanation",
                "code": {
                    "html": "Complete HTML code",
                    "css": "Complete CSS code", 
                    "js": "Complete JavaScript code"
                }
            }
            
            Make sure the code is modern, responsive, and follows best practices.`;
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: prompt }
                    ],
                    max_tokens: 3000,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'API request failed');
            }
            
            const data = await response.json();
            const content = data.choices[0]?.message?.content;
            
            if (!content) {
                throw new Error('No response from API');
            }
            
            try {
                return JSON.parse(content);
            } catch (parseError) {
                // If JSON parsing fails, create a structured response
                return {
                    thinking: content,
                    code: {
                        html: currentProject.html,
                        css: currentProject.css,
                        js: currentProject.js
                    }
                };
            }
        }
        
        // Utility functions
        function updateThinking(text) {
            document.getElementById('thinkingText').innerHTML = `<div class="fade-in" style="white-space: pre-wrap;">${text}</div>`;
        }
        
        function clearThinking() {
            document.getElementById('thinkingText').innerHTML = `
                <div class="text-center text-gray-500 mt-20">
                    <i class="fas fa-lightbulb text-4xl mb-4"></i>
                    <p class="text-lg">AI thoughts and explanations will appear here...</p>
                    <p class="text-sm mt-2">Enter a prompt below and click Generate to see the AI's thinking process.</p>
                </div>
            `;
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 fade-in ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Make functions global for onclick handlers
        window.loadProject = loadProject;
        window.deleteProject = deleteProject;
    </script>
</body>
</html>
